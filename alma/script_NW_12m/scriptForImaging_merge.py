"""
Joint imaging of 7m and 12m data
"""

# scp /Volumes/passport/alma/sgrb2_b3/2013.1.00269.S/science_goal.uid___A001_X121_X4b6/group.uid___A001_X121_X4b7/member.uid___A001_X121_X4bc/calibrated/calibrated.ms cleese:/scratch/aginsbur/sgrb2/2013.1.00269.S/science_goal.uid___A001_X121_X4b6/group.uid___A001_X121_X4b7/member.uid___A001_X121_X4bc/calibrated/SgrB2_a_03_7M.calibrated.ms
# member.uid___A001_X122_X35e  member.uid___A001_X122_X360
inputvis = ['../member.uid___A001_X122_X35e/calibrated/calibrated_final.ms',
            '../member.uid___A001_X122_X360/calibrated/calibrated_final.ms',
            ]
concatvis = 'Orion_NW_merge_7m_12m.ms'
if not os.path.exists(concatvis):
    concat(vis=inputvis, concatvis=concatvis)
    plotms(vis=concatvis,yaxis='wt',xaxis='uvdist',spw='0~2:200',
           coloraxis='spw',plotfile='combine_WT.png', showgui=False)


contvis=concatvis+".cont"
if not os.path.exists(contvis):
    print("Creating {0} by flagging data.".format(contvis))
    # Set continuum spws here based on plotms output.
    contspws = '0~39'

    flagmanager(vis=concatvis,mode='save',
                versionname='before_cont_flags')

    # Flag the "line channels"
    flagchannels='0:150~400,0:780~840, 0:960~990, 0:1020~1090,0:1550~1570, 0:1610~1690,0:1720~1780,' + \
                 '4:150~400,4:780~840, 4:960~990, 4:1020~1090,4:1550~1570, 4:1610~1690,4:1720~1780,' + \
                 '8:150~400,8:780~840, 8:960~990, 8:1020~1090,8:1550~1570, 8:1610~1690,8:1720~1780,' + \
                 '12:150~400,12:780~840, 12:960~990, 12:1020~1090,12:1550~1570, 12:1610~1690,12:1720~1780,' + \
                 '16:150~400,16:780~840, 16:960~990, 16:1020~1090,16:1550~1570, 16:1610~1690,16:1720~1780,' + \
                 '20:150~400,20:780~840, 20:960~990, 20:1020~1090,20:1550~1570, 20:1610~1690,20:1720~1780,' + \
                 '24:150~400,24:780~840, 24:960~990, 24:1020~1090,24:1550~1570, 24:1610~1690,24:1720~1780,' + \
                 '28:150~400,28:780~840, 28:960~990, 28:1020~1090,28:1550~1570, 28:1610~1690,28:1720~1780,' + \
                 '32:150~400,32:780~840, 32:960~990, 32:1020~1090,32:1550~1570, 32:1610~1690,32:1720~1780,' + \
                 '36:150~400,36:780~840, 36:960~990, 36:1020~1090,36:1550~1570, 36:1610~1690,36:1720~1780,' + \
                 '1:0~50, 1:190~450, 1:680~750,1:1450~1500, 1:1750~3750,' + \
                 '5:0~50, 5:190~450, 5:680~750,5:1450~1500, 5:1750~3750,' + \
                 '9:0~50, 9:190~450, 9:680~750,9:1450~1500, 9:1750~3750,' + \
                 '13:0~50, 13:190~450, 13:680~750,13:1450~1500, 13:1750~3750,' + \
                 '17:0~50, 17:190~450, 17:680~750,17:1450~1500, 17:1750~3750,' + \
                 '21:0~50, 21:190~450, 21:680~750,21:1450~1500, 21:1750~3750,' + \
                 '25:0~50, 25:190~450, 25:680~750,25:1450~1500, 25:1750~3750,' + \
                 '29:0~50, 29:190~450, 29:680~750,29:1450~1500, 29:1750~3750,' + \
                 '33:0~50, 33:190~450, 33:680~750,33:1450~1500, 33:1750~3750,' + \
                 '37:0~50, 37:190~450, 37:680~750,37:1450~1500, 37:1750~3750,' + \
                 '2:0~120,2:200~300,2:600~650,2:750~800,2:900~950,2:1000~1100,2:1400~1450,2:1550~1600,' + \
                     '2:1850~1950,2:2100~2150,2:2200~2350,2:2400~2600,2:2780~2900,2:3050~3100,2:3280~3500,2:3600~3750,' + \
                 '6:0~120,6:200~300,6:600~650,6:750~800,6:900~950,6:1000~1100,6:1400~1450,6:1550~1600,' + \
                     '6:1850~1950,6:2100~2150,6:2200~2350,6:2400~2600,6:2780~2900,6:3050~3100,6:3280~3500,6:3600~3750,' + \
                 '10:0~120,10:200~300,10:600~650,10:750~800,10:900~950,10:1000~1100,10:1400~1450,10:1550~1600,' + \
                     '10:1850~1950,10:2100~2150,10:2200~2350,10:2400~2600,10:2780~2900,10:3050~3100,10:3280~3500,10:3600~3750,' + \
                 '14:0~120,14:200~300,14:600~650,14:750~800,14:900~950,14:1000~1100,14:1400~1450,14:1550~1600,' + \
                     '14:1850~1950,14:2100~2150,14:2200~2350,14:2400~2600,14:2780~2900,14:3050~3100,14:3280~3500,14:3600~3750,' + \
                 '18:0~120,18:200~300,18:600~650,18:750~800,18:900~950,18:1000~1100,18:1400~1450,18:1550~1600,' + \
                     '18:1850~1950,18:2100~2150,18:2200~2350,18:2400~2600,18:2780~2900,18:3050~3100,18:3280~3500,18:3600~3750,' + \
                 '22:0~120,22:200~300,22:600~650,22:750~800,22:900~950,22:1000~1100,22:1400~1450,22:1550~1600,' + \
                     '22:1850~1950,22:2100~2150,22:2200~2350,22:2400~2600,22:2780~2900,22:3050~3100,22:3280~3500,22:3600~3750,' + \
                 '26:0~120,26:200~300,26:600~650,26:750~800,26:900~950,26:1000~1100,26:1400~1450,26:1550~1600,' + \
                     '26:1850~1950,26:2100~2150,26:2200~2350,26:2400~2600,26:2780~2900,26:3050~3100,26:3280~3500,26:3600~3750,' + \
                 '30:0~120,30:200~300,30:600~650,30:750~800,30:900~950,30:1000~1100,30:1400~1450,30:1550~1600,' + \
                     '30:1850~1950,30:2100~2150,30:2200~2350,30:2400~2600,30:2780~2900,30:3050~3100,30:3280~3500,30:3600~3750,' + \
                 '34:0~120,34:200~300,34:600~650,34:750~800,34:900~950,34:1000~1100,34:1400~1450,34:1550~1600,' + \
                     '34:1850~1950,34:2100~2150,34:2200~2350,34:2400~2600,34:2780~2900,34:3050~3100,34:3280~3500,34:3600~3750,' + \
                 '38:0~120,38:200~300,38:600~650,38:750~800,38:900~950,38:1000~1100,38:1400~1450,38:1550~1600,' + \
                     '38:1850~1950,38:2100~2150,38:2200~2350,38:2400~2600,38:2780~2900,38:3050~3100,38:3280~3500,38:3600~3750,' + \
                 '3:100~150, 3:300~500, 3:640~720,3:800~1000,3:1150~1200,3:1250~1320,3:1350~1400,3:1450~2000,3:2350~2400,3:2500~2650,3:2800~2850,3:3070~3200,3:3280~3839,' + \
                 '7:100~150, 7:300~500, 7:640~720,7:800~1000,7:1150~1200,7:1250~1320,7:1350~1400,7:1450~2000,7:2350~2400,7:2500~2650,7:2800~2850,7:3070~3200,7:3280~3839,' + \
                 '11:100~150, 11:300~500, 11:640~720,11:800~1000,11:1150~1200,11:1250~1320,11:1350~1400,11:1450~2000,11:2350~2400,11:2500~2650,11:2800~2850,11:3070~3200,11:3280~3839,' + \
                 '15:100~150, 15:300~500, 15:640~720,15:800~1000,15:1150~1200,15:1250~1320,15:1350~1400,15:1450~2000,15:2350~2400,15:2500~2650,15:2800~2850,15:3070~3200,15:3280~3839,' + \
                 '19:100~150, 19:300~500, 19:640~720,19:800~1000,19:1150~1200,19:1250~1320,19:1350~1400,19:1450~2000,19:2350~2400,19:2500~2650,19:2800~2850,19:3070~3200,19:3280~3839,' + \
                 '23:100~150, 23:300~500, 23:640~720,23:800~1000,23:1150~1200,23:1250~1320,23:1350~1400,23:1450~2000,23:2350~2400,23:2500~2650,23:2800~2850,23:3070~3200,23:3280~3839' + \
                 '27:100~150, 27:300~500, 27:640~720,27:800~1000,27:1150~1200,27:1250~1320,27:1350~1400,27:1450~2000,27:2350~2400,27:2500~2650,27:2800~2850,27:3070~3200,27:3280~3839' + \
                 '31:100~150, 31:300~500, 31:640~720,31:800~1000,31:1150~1200,31:1250~1320,31:1350~1400,31:1450~2000,31:2350~2400,31:2500~2650,31:2800~2850,31:3070~3200,31:3280~3839' + \
                 '35:100~150, 35:300~500, 35:640~720,35:800~1000,35:1150~1200,35:1250~1320,35:1350~1400,35:1450~2000,35:2350~2400,35:2500~2650,35:2800~2850,35:3070~3200,35:3280~3839' + \
                 '39:100~150, 39:300~500, 39:640~720,39:800~1000,39:1150~1200,39:1250~1320,39:1350~1400,39:1450~2000,39:2350~2400,39:2500~2650,39:2800~2850,39:3070~3200,39:3280~3839'

    flagdata(vis=concatvis,mode='manual',
              spw=flagchannels,flagbackup=False)

    # check that flags are as expected, NOTE must check reload on plotms
    # gui if its still open.
    #plotms(vis=concatvis,yaxis='amp',xaxis='channel',
    #       avgchannel='2',avgtime='1e8',avgscan=True,iteraxis='spw')

    # Average the channels within spws
    rmtables(contvis)
    os.system('rm -rf ' + contvis + '.flagversions')
    split(vis=concatvis,
          spw=contspws,
          outputvis=contvis,
          # number of channels to average together. change to appropriate value for
          # each spectral window in contspws (use listobs to find) and make sure to
          # use the native number of channels per SPW (that is, not the number of
          # channels left after flagging any lines)
          width=[1920,3840,3840,3840]*10,
          datacolumn='data')

    # Note: There is a bug in split that does not average the data
    # properly if the width is set to a value larger than the number of
    # channels in an SPW. Specifying the width of each spw (as done above)
    # is necessary for producing properly weighted data.

    # Restore the flags
    flagmanager(vis=concatvis,mode='restore',
                versionname='before_cont_flags')

linevis = concatvis+'.contsub'
if not os.path.exists(linevis):
    print("Fitting continuum to create {0}".format(linevis))

    # line-free channel for fitting continuum
    fitspw='0:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '4:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '8:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '12:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '16:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '20:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '24:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '28:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '32:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '36:0~149;401~779;841~959;991~1019;1091~1549;1571~1609;1691~1719;1781~1919,' + \
    '1:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '5:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '9:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '13:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '17:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '21:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '25:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '29:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '33:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '37:51~189;451~679;751~1449;1501~1749;1751~3839,' + \
    '2:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;' + \
    '1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '6:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;' + \
    '1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '10:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;' + \
    '1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '14:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;' + \
    '1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '18:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;' + \
    '1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '22:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '26:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '30:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '34:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '38:121~199;299~599;649~749;801~899;951~999;1101~1399;1451~1549;1601~1849;1951~2099;2151~2199;2351~2399;2601~2779;2901~3049;3101~3279;3501~3599;3751~3839,' + \
    '3:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279,' + \
    '7:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279,' + \
    '11:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279,' + \
    '15:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279,' + \
    '19:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279,' + \
    '23:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279'
    '27:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279'
    '31:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279'
    '35:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279'
    '39:0~99;151~299;501~639;721~799;1001~1149;1201~1249;1321~1349;1401~1449;2001~2349;2401~2499;2651~2799;2851~3069;3201~3279'


    linespw = '0~39' # line spectral windows. You can subtract the continuum from multiple spectral line windows at once.

    uvcontsub(vis=concatvis,
              spw=linespw, # spw to do continuum subtraction on
              fitspw=fitspw, # select spws to fit continuum. exclude regions with strong lines.
              combine='spw',
              solint='int',
              fitorder=1,
              want_cont=False) # This value should not be changed.

    #split(vis=finalvis+".contsub", 
    #      outputvis=finalvis+".contsub.corrected"

    # NOTE: Imaging the continuum produced by uvcontsub with
    # want_cont=True will lead to extremely poor continuum images because
    # of bandwidth smearing effects. For imaging the continuum, you should
    # always create a line-free continuum data set using the process
    # outlined above.

start='-240km/s' # start velocity. See science goals for appropriate value.
width='1.46km/s' # velocity width. See science goals.
nchan = 300  # number of channels. See science goals for appopriate value.
outframe='lsrk' # velocity reference frame. See science goals.
veltype='radio' # velocity type. See note below.
restfreq='230.538GHz' # Typically the rest frequency of the line of
                        # interest. If the source has a significant
                        # redshift (z>0.2), use the observed sky
                        # frequency (nu_rest/(1+z)) instead of the
                        # rest frequency of the
                        # line.
#phasecenter=51  #to move it over a little?
phasecenter = 'J2000 5h35m12.023 -5d21m33.65'
cell='.2arcsec' # cell size for imaging.
imsize = [700,1200] # size of image in pixels.
weighting = 'briggs'
robust=0.5
niter=1000
threshold = '0.0mJy'
field='OMC1_NW'
imagermode='mosaic' # uncomment if mosaic

# Note on veltype: We recommend keeping veltype set to radio,
# regardless of the velocity frame listed the object in the OT. If the
# sensitivity is defined using a velocity width, then the 'radio'
# definition of the velocity frame is used regardless of the velocity
# definition in the "source parameters" tab of the OT.

for ext in ['.flux','.image','.mask','.model','.pbcor','.psf','.residual','.flux.pbcoverage']:
    rmtables(lineimagename + ext)

print("Imaging the Continuuum")

# If necessary, run the following commands to get rid of older clean
# data.

clearcal(vis=contvis)
delmod(vis=contvis)

contimagename = 'calibrated_final_cont_image'

for ext in ['.flux','.image','.mask','.model','.pbcor','.psf','.residual','.flux.pbcoverage']:
    rmtables(contimagename+ext)

clean(vis=contvis,
      imagename=contimagename,
      field=field,
      phasecenter=phasecenter, # uncomment if mosaic.
      mode='mfs',
      psfmode='clark',
      imsize = imsize,
      cell= cell,
      weighting = weighting,
      robust = robust,
      niter = niter,
      threshold = threshold,
      interactive = True,
      imagermode = imagermode)


lineimagename = 'Orion_7m_12m_merge_12CO_2-1' # name of line image
print("Cleaning CO: {0}".format(lineimagename))
niter = 10000
threshold = '30mJy'

for ext in ['.flux','.image','.mask','.model','.pbcor','.psf','.residual','.flux.pbcoverage']:
    rmtables(lineimagename+ext)

linevis=concatvis
clean(vis=linevis,
      imagename=lineimagename,
      field=field,
      spw='0,4,8,12,16,20,24,28,32,36',
      phasecenter=phasecenter, # uncomment if mosaic.
      mode='velocity',
      start=start,
      width=width,
      nchan=nchan,
      outframe=outframe,
      veltype=veltype,
      restfreq=restfreq,
      niter=niter,
      threshold=threshold,
      interactive=False,
      cell=cell,
      imsize=imsize,
      weighting=weighting,
      robust=robust,
      imagermode=imagermode,
      minpb=0.4,
      usescratch=False)

exportfits(lineimagename+".image", lineimagename+".image.fits", dropdeg=True, overwrite=True)
